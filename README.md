This is not a checked implementation, it's mostly correct for sure but may have some minor bugs.
